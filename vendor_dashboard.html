{% extends "base.html" %}
{% block title %}Vendor Dashboard{% endblock %}
{% block content %}
<h2>Welcome Vendor, {{ user.fullname or user.email }}</h2>
<p class="muted">Manage orders, earnings and store profile.</p>

<div style="margin-bottom:14px">
  <button id="btnPerm" class="btn">Enable Notifications</button>
  <button id="btnSim" class="btn outline">Simulate New Order</button>
</div>

<div class="grid">
  <a class="card" href="#">New Orders</a>
  <a class="card" href="#">Manage Orders</a>
  <a class="card" href="{{ url_for('welcome', role='vendor') }}">Wallet</a>
  <a class="card" href="#">Store Profile</a>
</div>
<script>
  document.getElementById('btnPerm').addEventListener('click', async ()=>{
    if(!('Notification' in window)) return alert('Notifications not supported');
    const p = await Notification.requestPermission(); if(p === 'granted') alert('Notifications allowed');
  });
  document.getElementById('btnSim').addEventListener('click', async ()=>{
    await fetch('/notify', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({role:'vendor', message:'Simulated new order #'+Math.floor(Math.random()*900+100)})
    });
    alert('Simulated server notification created');
  });
  // poll notifications
  setInterval(async ()=>{
    try {
      const res = await fetch('/notifications'); if(res.status===401) return;
      const j = await res.json();
      if(j.ok && j.notifications.length){
        j.notifications.forEach(n=>{
          if(Notification.permission==='granted') new Notification('ArewaDeliver', {body:n.message});
          else alert('Notification: '+n.message);
        });
      }
    } catch(e){console.error(e)}
  }, 5000);
</script>
{% endblock %}